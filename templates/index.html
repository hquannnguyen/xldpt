<!DOCTYPE html>
<html lang="vi" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic Photo Editor</title>
    <!-- Font & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- CSS Libraries -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />
    <style>
      :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --dark-color: #1b263b;
        --light-color: #f8f9fa;
        --danger-color: #f72585;
        --success-color: #4cc9f0;
        --warning-color: #f8961e;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      [data-theme="dark"] {
        --primary-color: #4895ef;
        --secondary-color: #4361ee;
        --accent-color: #3f37c9;
        --dark-color: #f8f9fa;
        --light-color: #1b263b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--light-color);
        color: var(--dark-color);
        transition: var(--transition);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header */
      .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        margin-bottom: 30px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .app-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .theme-toggle {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--dark-color);
        font-size: 1.5rem;
      }

      /* Upload Section */
      .upload-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 30px;
        margin-bottom: 30px;
        transition: var(--transition);
        background-color: var(--light-color);
      }

      .upload-area {
        border: 2px dashed var(--primary-color);
        border-radius: var(--border-radius);
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        margin-bottom: 20px;
      }

      .upload-area:hover {
        background-color: rgba(67, 97, 238, 0.05);
      }

      .upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
      }

      /* Tabs */
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      .tab {
        padding: 12px 24px;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: var(--transition);
        font-weight: 500;
      }

      .tab.active {
        border-bottom: 3px solid var(--primary-color);
        color: var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Control Cards */
      .control-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 20px;
        margin-bottom: 20px;
        transition: var(--transition);
        background-color: var(--light-color);
      }

      .control-card h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      /* Sliders */
      .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .slider-container input[type="range"] {
        flex-grow: 1;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
      }

      .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
      }

      .slider-value {
        width: 50px;
        text-align: center;
        background: rgba(67, 97, 238, 0.1);
        padding: 5px;
        border-radius: 4px;
        font-weight: 500;
      }

      /* Buttons */
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary {
        background-color: var(--accent-color);
        color: white;
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: white;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      /* Image Preview */
      .image-preview {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
      }

      .image-container {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 20px;
        transition: var(--transition);
        background-color: var(--light-color);
      }

      .image-container h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
      }

      .image-container img {
        max-width: 100%;
        max-height: 400px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        display: block;
        margin: 0 auto;
      }

      /* Cropper */
      .cropper-container {
        margin: 20px auto;
        max-width: 100%;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .image-preview {
          grid-template-columns: 1fr;
        }

        .tabs {
          overflow-x: auto;
          white-space: nowrap;
          padding-bottom: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- App Header -->
      <header class="app-header">
        <h1 class="app-title">
          <span class="material-icons">photo_camera</span>
          Magic Photo Editor
        </h1>
        <button class="theme-toggle" id="themeToggle">
          <span class="material-icons">brightness_4</span>
        </button>
      </header>

      <!-- Upload Section -->
      <section class="upload-card">
        <form
          action="/upload"
          method="post"
          enctype="multipart/form-data"
          id="uploadForm"
        >
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
              <span class="material-icons">cloud_upload</span>
            </div>
            <h3>Kéo thả ảnh vào đây hoặc click để chọn</h3>
            <p>Hỗ trợ: JPG, PNG, GIF (Tối đa 5MB)</p>
            <input
              type="file"
              name="file"
              id="fileInput"
              accept="image/*"
              style="display: none"
            />
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              <span class="material-icons">upload</span>
              Tải Ảnh Lên
            </button>
          </div>
        </form>
      </section>

      {% if uploaded_img %}
      <!-- Main Editor -->
      <div class="editor-container">
        <!-- Tabs Navigation -->
        <div class="tabs">
          <div class="tab active" data-tab="filters">Bộ Lọc</div>
          <div class="tab" data-tab="adjustments">Điều Chỉnh</div>
          <div class="tab" data-tab="effects">Hiệu Ứng</div>
          <div class="tab" data-tab="tools">Công Cụ</div>
        </div>

        <!-- Tab Contents -->
        <form action="/process" method="post" id="processForm">
          <input type="hidden" name="uploaded_img" value="{{ uploaded_img }}" />
          <input
            type="hidden"
            name="thumbnail_img"
            value="{{ thumbnail_img }}"
          />

          <!-- Filters Tab -->
          <div class="tab-content active" id="filters">
            <div class="control-card">
              <h3>
                <span class="material-icons">filter_b_and_w</span> Bộ Lọc Màu
              </h3>
              <div class="control-group">
                <select name="filter" class="form-select">
                  <option value="none">Không Lọc</option>
                  <option value="grayscale">Trắng Đen</option>
                  <option value="blur">Làm Mờ</option>
                  <option value="enhance">Tăng Chi Tiết</option>
                  <option value="sharpen">Làm Sắc Nét</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Adjustments Tab -->
          <div class="tab-content" id="adjustments">
            <div class="control-card">
              <h3>
                <span class="material-icons">brightness_6</span> Độ Sáng & Tương
                Phản
              </h3>
              <div class="control-group">
                <label>Độ Sáng</label>
                <div class="slider-container">
                  <input
                    type="range"
                    name="brightness"
                    min="0.1"
                    max="3.0"
                    step="0.1"
                    value="1.0"
                    oninput="document.getElementById('brightnessValue').textContent = this.value"
                  />
                  <span class="slider-value" id="brightnessValue">1.0</span>
                </div>
              </div>
              <div class="control-group">
                <label>Độ Tương Phản</label>
                <div class="slider-container">
                  <input
                    type="range"
                    name="contrast"
                    min="0.1"
                    max="3.0"
                    step="0.1"
                    value="1.0"
                    oninput="document.getElementById('contrastValue').textContent = this.value"
                  />
                  <span class="slider-value" id="contrastValue">1.0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Effects Tab -->
          <div class="tab-content" id="effects">
            <div class="control-card">
              <h3>
                <span class="material-icons">auto_fix_high</span> Hiệu Ứng Đặc
                Biệt
              </h3>
              <div class="control-group">
                <label>Phát Hiện Cạnh</label>
                <div>
                  <label
                    ><input type="radio" name="edge" value="none" checked />
                    Không</label
                  >
                  <label
                    ><input type="radio" name="edge" value="canny" />
                    Canny</label
                  >
                  <label
                    ><input type="radio" name="edge" value="sobel" />
                    Sobel</label
                  >
                </div>
              </div>
              <div class="control-group">
                <label
                  ><input type="checkbox" name="face_detect" value="on" /> Nhận
                  Diện Khuôn Mặt</label
                >
              </div>
            </div>
          </div>

          <!-- Tools Tab -->
          <div class="tab-content" id="tools">
            <div class="control-card">
              <h3><span class="material-icons">transform</span> Biến Đổi</h3>
              <div class="control-group">
                <label>Xoay Ảnh</label>
                <select name="rotate" class="form-select">
                  <option value="0">0°</option>
                  <option value="90">90°</option>
                  <option value="180">180°</option>
                  <option value="270">270°</option>
                </select>
              </div>
              <div class="control-group">
                <label>Lật Ảnh</label>
                <div>
                  <label
                    ><input type="radio" name="flip" value="none" checked />
                    Không Lật</label
                  >
                  <label
                    ><input type="radio" name="flip" value="horizontal" /> Lật
                    Ngang</label
                  >
                  <label
                    ><input type="radio" name="flip" value="vertical" /> Lật
                    Dọc</label
                  >
                </div>
              </div>
            </div>

            <div class="control-card">
              <h3><span class="material-icons">crop</span> Cắt Ảnh</h3>
              <div class="btn-group">
                <button type="button" class="btn btn-secondary" id="startCrop">
                  <span class="material-icons">crop_free</span>
                  Bắt Đầu Crop
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="applyCrop"
                  style="display: none"
                >
                  <span class="material-icons">check</span>
                  Áp Dụng
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="cancelCrop"
                  style="display: none"
                >
                  <span class="material-icons">close</span>
                  Hủy Bỏ
                </button>
              </div>
            </div>

            <div class="control-card">
              <h3><span class="material-icons">file_download</span> Đầu Ra</h3>
              <div class="control-group">
                <label>Định Dạng</label>
                <div>
                  <label
                    ><input
                      type="radio"
                      name="format"
                      value="original"
                      checked
                    />
                    Giữ Nguyên</label
                  >
                  <label
                    ><input type="radio" name="format" value="jpg" /> JPG</label
                  >
                  <label
                    ><input type="radio" name="format" value="png" /> PNG</label
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Hidden Crop Form -->
          <form
            id="cropForm"
            action="/crop"
            method="post"
            style="display: none"
          >
            <input
              type="hidden"
              name="uploaded_img"
              value="{{ uploaded_img }}"
            />
            <input type="hidden" name="x" id="cropX" />
            <input type="hidden" name="y" id="cropY" />
            <input type="hidden" name="width" id="cropWidth" />
            <input type="hidden" name="height" id="cropHeight" />
          </form>

          <!-- Action Buttons -->
          <div class="btn-group" style="margin-top: 30px">
            <button type="submit" class="btn btn-primary">
              <span class="material-icons">auto_fix_high</span>
              Áp Dụng Hiệu Ứng
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="location.href='/'"
            >
              <span class="material-icons">refresh</span>
              Làm Mới
            </button>
            {% if processed_img %}
            <button
              type="button"
              class="btn btn-success"
              onclick="location.href='/download'"
            >
              <span class="material-icons">file_download</span>
              Tải Xuống
            </button>
            {% endif %}
          </div>
        </form>
      </div>

      <!-- Image Preview -->
      <div class="image-preview">
        <div class="image-container">
          <h3><span class="material-icons">image</span> Ảnh Gốc</h3>
          <img id="sourceImage" src="{{ thumbnail_img }}" alt="Ảnh Gốc" />
        </div>
        {% if processed_img %}
        <div class="image-container">
          <h3><span class="material-icons">adjust</span> Ảnh Đã Xử Lý</h3>
          <img src="{{ processed_img }}" alt="Ảnh Đã Xử Lý" />
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
      // Theme Toggle
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", () => {
        document.documentElement.setAttribute(
          "data-theme",
          document.documentElement.getAttribute("data-theme") === "light"
            ? "dark"
            : "light"
        );

        themeToggle.innerHTML =
          document.documentElement.getAttribute("data-theme") === "light"
            ? '<span class="material-icons">brightness_4</span>'
            : '<span class="material-icons">brightness_7</span>';
      });

      // Tab System
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // Remove active class from all tabs and contents
          document
            .querySelectorAll(".tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          // Add active class to clicked tab and corresponding content
          tab.classList.add("active");
          const tabId = tab.getAttribute("data-tab");
          document.getElementById(tabId).classList.add("active");
        });
      });

      // Upload Area Click
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");

      uploadArea.addEventListener("click", () => {
        fileInput.click();
      });

      // File Input Change
      fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) {
          document.getElementById("uploadForm").submit();
        }
      });

      // Drag and Drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "rgba(67, 97, 238, 0.1)";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.backgroundColor = "";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";

        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          document.getElementById("uploadForm").submit();
        }
      });

      // Cropper Functionality
      let cropper;
      const sourceImage = document.getElementById("sourceImage");
      const startCropBtn = document.getElementById("startCrop");
      const applyCropBtn = document.getElementById("applyCrop");
      const cancelCropBtn = document.getElementById("cancelCrop");

      startCropBtn.addEventListener("click", () => {
        // Show crop buttons
        startCropBtn.style.display = "none";
        applyCropBtn.style.display = "inline-block";
        cancelCropBtn.style.display = "inline-block";

        // Initialize cropper
        cropper = new Cropper(sourceImage, {
          aspectRatio: NaN,
          viewMode: 1,
          autoCropArea: 0.8,
          responsive: true,
          movable: true,
          zoomable: true,
          guides: true,
        });
      });

      applyCropBtn.addEventListener("click", () => {
        // Get crop data
        const cropData = cropper.getData();

        // Fill crop form
        document.getElementById("cropX").value = Math.round(cropData.x);
        document.getElementById("cropY").value = Math.round(cropData.y);
        document.getElementById("cropWidth").value = Math.round(cropData.width);
        document.getElementById("cropHeight").value = Math.round(
          cropData.height
        );

        // Submit crop form
        document.getElementById("cropForm").submit();
      });

      cancelCropBtn.addEventListener("click", () => {
        // Destroy cropper
        if (cropper) {
          cropper.destroy();
        }

        // Reset buttons
        startCropBtn.style.display = "inline-block";
        applyCropBtn.style.display = "none";
        cancelCropBtn.style.display = "none";

        // Reset image
        sourceImage.style.transform = "";
      });
    </script>
  </body>
</html>
